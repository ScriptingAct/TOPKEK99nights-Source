local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

local UNC_CHECK_INTERVAL = 0.1 -- ตรวจสอบทุก 0.1 วิ
local UNC_SAFE_THRESHOLD = 5 -- กำหนดว่า <= 5 ถือว่าปลอดภัย

local function CheckUNC()
    -- ตัวอย่างสุ่มเลขจำลอง (แทนที่ด้วยโค้ดตรวจสอบจริง)
    return math.random(0, 10)
end

local Window = Fluent:CreateWindow({
    Title = "TOPKEK PREMIUM [99 nights] เวอร์ชั่นไลต์ " .. Fluent.Version,
    SubTitle = "by Alexzy123",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Amethyst",
    MinimizeKey = Enum.KeyCode.RightControl
})

local Tabs = {
    Main = Window:AddTab({ Title = "เมนูหลัก", Icon = "shield" }),
    Settings = Window:AddTab({ Title = "การตั้งค่า", Icon = "settings" }),
}

-- ฟังก์ชันอัปเดต Title และ Icon ตาม UNC
local function UpdateTitleAndIcon(unc)
    local safe = unc <= UNC_SAFE_THRESHOLD
    local statusText = safe and "ปลอดภัย" or "ไม่ปลอดภัย"
    local iconName = safe and "shield" or "warning"

    Window:SetTitle("TOPKEK PREMIUM [99 nights] เวอร์ชั่นไลต์ " .. Fluent.Version .. " | UNC: " .. unc .. " | " .. statusText)
    Tabs.Main:SetIcon(iconName)
end

-- เริ่มตรวจสอบ UNC แบบ Loop เรียลไทม์
task.spawn(function()
    while not Fluent.Unloaded do
        local unc = CheckUNC()
        UpdateTitleAndIcon(unc)
        task.wait(UNC_CHECK_INTERVAL)
    end
end)

-- ตัวอื่นๆ ตามสคริปต์เดิม (walkspeed, fly, etc.) ใส่ในนี้ต่อไป
local Options = Fluent.Options

do
    -- WalkSpeed Toggle และ Slider
    local walkSpeedToggle = Tabs.Main:AddToggle("WalkSpeedToggle", {
        Title = "เดินเร็ว (เปิด-ปิด)",
        Description = "เปิดเพื่อปรับความเร็วเดินเป็นค่าที่ตั้งไว้",
        Default = false
    })
    local walkSpeedSlider = Tabs.Main:AddSlider("WalkSpeedValue", {
        Title = "ความเร็วเดิน",
        Description = "ปรับความเร็วเดิน (เมื่อเปิด toggle เท่านั้น)",
        Default = 16,
        Min = 16,
        Max = 100,
        Rounding = 1,
    })

    walkSpeedToggle:OnChanged(function(enabled)
        if not enabled then
            local player = game.Players.LocalPlayer
            if player and player.Character then
                local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
                if humanoid then
                    humanoid.WalkSpeed = 16
                end
            end
        end
    end)

    task.spawn(function()
        while true do
            task.wait(1)
            if Fluent.Unloaded then break end
            if Options.WalkSpeedToggle.Value then
                local player = game.Players.LocalPlayer
                if player and player.Character then
                    local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
                    if humanoid then
                        humanoid.WalkSpeed = Options.WalkSpeedValue.Value
                    end
                end
            end
        end
    end)

    -- FlySpeed Slider
    local flySpeedSlider = Tabs.Main:AddSlider("FlySpeed", {
        Title = "ความเร็วบิน",
        Description = "ปรับความเร็วบิน",
        Default = 61,
        Min = 10,
        Max = 200,
        Rounding = 1,
    })

    -- NoFog Toggle Loop
    local Lighting = game:GetService("Lighting")
    local originalFogEnd = Lighting.FogEnd
    local originalFogStart = Lighting.FogStart

    local NoFogToggle = Tabs.Main:AddToggle("NoFog", {
        Title = "ปิดหมอก",
        Default = false
    })

    local noFogLoopRunning = false
    NoFogToggle:OnChanged(function(value)
        if value then
            noFogLoopRunning = true
            task.spawn(function()
                while noFogLoopRunning and not Fluent.Unloaded do
                    Lighting.FogEnd = 1000000
                    Lighting.FogStart = 0
                    task.wait(0.5)
                end
            end)
        else
            noFogLoopRunning = false
            Lighting.FogEnd = originalFogEnd
            Lighting.FogStart = originalFogStart
        end
    end)

    -- Fly Toggle
    local UserInputService = game:GetService("UserInputService")
    local RunService = game:GetService("RunService")

    local flying = false
    local player = game.Players.LocalPlayer

    local flyToggle = Tabs.Main:AddToggle("FlyToggle", {
        Title = "บิน [กด T เพื่อบินขึ้น กด G เพื่อบินลง]",
        Default = false
    })

    local bodyVelocity, bodyGyro

    flyToggle:OnChanged(function(enabled)
        flying = enabled

        local character = player.Character or player.CharacterAdded:Wait()
        local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
        local humanoid = character:FindFirstChildOfClass("Humanoid")

        if flying then
            humanoid.PlatformStand = true

            bodyVelocity = Instance.new("BodyVelocity")
            bodyVelocity.MaxForce = Vector3.new(1e5, 1e5, 1e5)
            bodyVelocity.Velocity = Vector3.new(0, 0, 0)
            bodyVelocity.Parent = humanoidRootPart

            bodyGyro = Instance.new("BodyGyro")
            bodyGyro.MaxTorque = Vector3.new(4e5, 4e5, 4e5)
            bodyGyro.P = 10000
            bodyGyro.CFrame = humanoidRootPart.CFrame
            bodyGyro.Parent = humanoidRootPart

            local function updateVelocity()
                if not flying then return end

                local cam = workspace.CurrentCamera
                local moveDirection = Vector3.new()

                if UserInputService:IsKeyDown(Enum.KeyCode.W) then
                    moveDirection = moveDirection + cam.CFrame.LookVector
                end
                if UserInputService:IsKeyDown(Enum.KeyCode.S) then
                    moveDirection = moveDirection - cam.CFrame.LookVector
                end
                if UserInputService:IsKeyDown(Enum.KeyCode.A) then
                    moveDirection = moveDirection - cam.CFrame.RightVector
                end
                if UserInputService:IsKeyDown(Enum.KeyCode.D) then
                    moveDirection = moveDirection + cam.CFrame.RightVector
                end
                if UserInputService:IsKeyDown(Enum.KeyCode.T) then -- บินขึ้น
                    moveDirection = moveDirection + Vector3.new(0,1,0)
                end
                if UserInputService:IsKeyDown(Enum.KeyCode.G) then -- บินลง
                    moveDirection = moveDirection - Vector3.new(0,1,0)
                end

                if moveDirection.Magnitude > 0 then
                    bodyVelocity.Velocity = moveDirection.Unit * Options.FlySpeed.Value
                    bodyGyro.CFrame = CFrame.new(humanoidRootPart.Position, humanoidRootPart.Position + moveDirection)
                else
                    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
                end
            end

            RunService:BindToRenderStep("Fly", Enum.RenderPriority.Character.Value + 1, updateVelocity)

        else
            humanoid.PlatformStand = false
            if bodyVelocity then
                bodyVelocity:Destroy()
                bodyVelocity = nil
            end
            if bodyGyro then
                bodyGyro:Destroy()
                bodyGyro = nil
            end
            RunService:UnbindFromRenderStep("Fly")
        end
    end)

    -- Infinite Jump Toggle
    local infJumpEnabled = false

    local infJumpToggle = Tabs.Main:AddToggle("InfJumpToggle", {
        Title = "กระโดดไม่จำกัด",
        Default = false
    })

    infJumpToggle:OnChanged(function(value)
        infJumpEnabled = value
    end)

    game:GetService("UserInputService").JumpRequest:Connect(function()
        if infJumpEnabled then
            local character = player.Character
            if character and character:FindFirstChildOfClass("Humanoid") then
                character:FindFirstChildOfClass("Humanoid"):ChangeState(Enum.HumanoidStateType.Jumping)
            end
        end
    end)
end

-- Settings Tab
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)

SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})

InterfaceManager:SetFolder("FluentScriptHub")
SaveManager:SetFolder("FluentScriptHub/specific-game")

InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)

Window:SelectTab(1)

Fluent:Notify({
    Title = "TOPKEK",
    Content = "ท็อปเค็ก (ภาษาไทย) ได้เริ่มดำเนินการแล้ว ",
    Duration = 8
})

SaveManager:LoadAutoloadConfig()
